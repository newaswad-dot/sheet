<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ุฃุฏุงุฉ ุงูุจุญุซ</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --border:#e6e8ef; --text:#1f2937; --muted:#6b7280;
      --blue:#2563eb; --blueH:#1d4ed8; --green:#16a34a; --greenH:#15803d;
      --red:#dc2626; --redH:#b91c1c; --amber:#f59e0b; --violet:#8b5cf6;
    }
    *{box-sizing:border-box}
    body{margin:0; padding:14px; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}

    .container{max-width:1100px; margin:0 auto; display:grid; gap:12px}
    @media(min-width:1060px){
      .container{ grid-template-columns: 1fr 1fr; align-items:start; }
      #advCard{ grid-column:1 }
      #personCard{ grid-column:2 }
      .span2{ grid-column:1 / span 2; }
    }
    @media(max-width:1059px){
      #advCard{ order:1 }
      #personCard{ order:2 }
    }

    .card{background:#fff; border:1px solid var(--border); border-radius:14px; padding:12px}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:nowrap}
    .row.stretch > *{flex:1}
    label.small{font-size:12px; color:var(--muted); margin-bottom:6px; display:block}
    input[type="text"], input[type="number"], select{
      width:100%; padding:10px 12px; border:1px solid var(--border);
      border-radius:10px; font-size:14px; background:#fff
    }
    button{border:0; border-radius:10px; padding:10px 12px; font-weight:600; cursor:pointer}
    .btn-blue{background:var(--blue); color:#fff} .btn-blue:hover{background:var(--blueH)}
    .btn-green{background:var(--green); color:#fff} .btn-green:hover{background:var(--greenH)}
    .btn-red{background:var(--red); color:#fff} .btn-red:hover{background:var(--redH)}
    .btn-ghost{background:#0000; border:1px solid var(--border); color:var(--text)}
    .muted{font-size:11px; color:var(--muted)}

    .results{
      min-height:120px; display:flex; flex-direction:column; justify-content:center; align-items:center;
      gap:10px; text-align:center; background:white; border-radius:12px; padding:16px;
      box-shadow:0 2px 6px rgba(0,0,0,0.06);
    }
    .badges{display:flex; gap:8px; flex-wrap:wrap; justify-content:center; align-items:center}
    .badge{font-size:12px; font-weight:700; padding:6px 10px; border-radius:999px; border:1px solid transparent; letter-spacing:.2px;}
    .badge--admin{ background:#fff7ed; color:#9a3412; border-color:#fdba74; }
    .badge--withdraw{ background:#eff6ff; color:#1d4ed8; border-color:#93c5fd; }
    .badge--agent{ background:#ecfdf5; color:#065f46; border-color:#6ee7b7; }
    .badge--missing{ background:#f9fafb; color:#6b7280; border-color:#ef4444; }
    .badge--loading{ background:#f3f4f6; color:#6b7280; border-color:#e5e7eb; }
    .badge--dup{ background:#fef2f2; color:#b91c1c; border-color:#fca5a5; }

    .amountBig{ font-size:44px; font-weight:900; line-height:1; }
    .subline{ font-size:12px; color:#6b7280; }

    .lastid{display:inline-flex; gap:6px; align-items:center; padding:6px 8px; border-radius:999px;
      border:1px solid var(--border); background:#fff; cursor:pointer; font-size:12px}

    #resultsBox, #advCard, #personCard { position:relative; }
    @keyframes flashGlowBlue  { 0%{box-shadow:0 0 0 0 rgba(59,130,246,0)} 25%{box-shadow:0 0 0 6px rgba(59,130,246,.22)} 100%{box-shadow:0 0 0 0 rgba(59,130,246,0)} }
    @keyframes flashGlowGreen { 0%{box-shadow:0 0 0 0 rgba(16,185,129,0)} 25%{box-shadow:0 0 0 6px rgba(16,185,129,.22)} 100%{box-shadow:0 0 0 0 rgba(16,185,129,0)} }
    .flash-blue { animation:flashGlowBlue  .42s ease; }
    .flash-green{ animation:flashGlowGreen .42s ease; }

    .row.stretch > button{ order:-1; flex:0 0 auto; min-width:110px; }
    .row.stretch > input, .row.stretch > select{ flex:1 1 auto; min-width:0; }

    /* Dark */
    body.dark{ background:#0f1115; color:#e5e7eb;}
    body.dark .card{ background:#1f232b; border-color:#2d323c; color:#e5e7eb; }
    body.dark input, body.dark select{ background:#111827; color:#f9fafb; border-color:#374151;}
    body.dark .results{ background:#1f232b; }
    body.dark .amountBig{ color:#22c55e; text-shadow:0 0 6px rgba(34,197,94,.7); }
    body.dark .lastid{ background:#111827; border-color:#2a2f39; color:#e5e7eb }
    body.dark .muted{ color:#cbd5e1; }
    body.dark .btn-ghost{ color:#e5e7eb; }
    body.dark .badge{ border-color:#374151; }

    /* iOS toggles */
    .ios-toggle{display:inline-flex;align-items:center;gap:10px;cursor:pointer;user-select:none}
    .ios-toggle input{opacity:0;width:0;height:0}
    .slider{position:relative;display:inline-block;width:50px;height:28px;background:#cfcfcf;border-radius:28px;transition:.25s}
    .slider:before{content:"";position:absolute;left:3px;bottom:3px;width:22px;height:22px;background:#fff;border-radius:50%;transition:.25s}
    input:checked + .slider{background:#34c759}
    input:checked + .slider:before{transform:translateX(22px)}
    body.dark input:checked + .slider{background:#22c55e}
    .switch-label{font-size:13px;font-weight:600;white-space:nowrap}
    .toggle-chip{display:flex;align-items:center;gap:10px;padding:6px 10px;border:1px solid var(--border);border-radius:14px;background:#fafafa}
    body.dark .toggle-chip{background:#111827;border-color:#2d323c}
    .toggles-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}

    /* bulk tool */
    #bulkCard{position:relative;}
    #bulkCard strong{font-size:16px;}
    #bulkCard .bulk-header{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:10px;}
    #bulkCard .bulk-header .muted{margin-inline-start:auto;}
    #bulkCard .bulk-section{margin-bottom:12px;}
    #bulkCard .bulk-textarea{width:100%;min-height:120px;padding:12px;border:1px solid var(--border);border-radius:12px;font-size:14px;font-family:inherit;resize:vertical;}
    #bulkCard .bulk-buttons{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    #bulkCard .bulk-buttons > button{flex:1 1 140px;min-height:44px;}
    #bulkNote{margin-top:6px;min-height:18px;}
    .bulk-progress{position:relative;background:rgba(37,99,235,0.08);border-radius:999px;height:10px;margin-top:16px;overflow:hidden;}
    .bulk-progress__bar{position:absolute;top:0;right:0;height:100%;width:0;background:var(--blue);transition:width .35s ease;}
    body.dark .bulk-progress{background:rgba(59,130,246,0.18);}
    body.dark .bulk-progress__bar{background:#60a5fa;}
    .bulk-metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px;margin-top:12px;font-size:13px;}
    .bulk-metrics span{display:block;color:var(--muted);font-size:12px;}
    .bulk-table-wrap{margin-top:14px;overflow:auto;max-height:320px;border:1px solid var(--border);border-radius:12px;}
    table#bulkResultsTable{width:100%;border-collapse:collapse;min-width:520px;}
    #bulkResultsTable thead th{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);padding:10px;font-size:12px;text-align:right;}
    #bulkResultsTable tbody td{padding:8px 10px;border-bottom:1px solid var(--border);font-size:13px;}
    #bulkResultsTable tbody tr:last-child td{border-bottom:0;}
    #bulkResultsTable tbody tr.bulk-row-colored{background:rgba(37,99,235,0.06);}
    body.dark #bulkResultsTable thead th{background:#1f232b;border-color:#2d323c;}
    body.dark #bulkResultsTable tbody td{border-color:#2d323c;}
    body.dark #bulkResultsTable tbody tr.bulk-row-colored{background:rgba(96,165,250,0.12);}
    body.dark #bulkCard .bulk-textarea{background:#111827;border-color:#374151;color:#f9fafb;}
    body.dark #bulkCard .bulk-metrics span{color:#9ca3af;}

/* Mobile-first tweaks */
html, body { max-width: 100%; overflow-x: hidden; }
.container { width: 100%; max-width: 940px; margin: 0 auto; padding: 10px; }
@media (max-width: 640px){
  .container{ max-width: 100% !important; padding: 12px !important; }
  .card{ border-radius: 14px !important; }
  .row{ flex-wrap: wrap !important; }
  input, button, select{ font-size: 16px !important; }
  #bulkCard .bulk-header{flex-direction:column;align-items:flex-start;gap:6px;}
  #bulkCard .bulk-buttons{flex-direction:column;}
  #bulkCard .bulk-buttons > button{flex:1 1 auto;width:100%;}
  #bulkCard .bulk-table-wrap{max-height:240px;}
}

</style>
</head>
<body>
  <div class="container">

    <!-- ุชุญููู ุงูุจูุงูุงุช -->
    <div class="card span2" id="loadCard">
      <div class="row stretch">
        <button id="reloadBtn" class="btn-red">ุชุญููู ุงูุจูุงูุงุช</button>
      </div>
      <div id="loadNote" class="muted" style="margin-top:6px"></div>
    </div>

    <!-- ุงูุจุญุซ -->
    <div class="card" id="searchCard">
      <label class="small">ID ููุจุญุซ</label>
      <div class="row stretch">
        <button id="pasteSearchBtn" class="btn-blue">ูุตู ุซู ุจุญุซ</button>
        <input id="idInput" type="text" placeholder="ุฃุฏุฎู ID ููุง" autocomplete="off" inputmode="numeric">
      </div>
      <div class="row" style="margin-top:6px; justify-content:space-between">
        <div id="pasteHint" class="muted"></div>
        <div id="lastIdPill" class="lastid" style="display:none">ุขุฎุฑ ID: <b id="lastIdText"></b></div>
      </div>
    </div>

    <!-- ุงููุชุงุฆุฌ -->
    <div class="card results" id="resultsBox">
      <div class="badges">
        <span id="statusBadge" class="badge badge--loading">โ</span>
        <span id="dupBadge" class="badge badge--dup" style="display:none">ููุฑุฑ</span>
        <span id="statusChipsRow"></span>
      </div>
      <!-- ุงุณู ุงูุนููู ูู ุนููุฏ B -->
      <div id="nameText" class="subline">โ</div>
            <div id="amountText" class="amountBig">โ</div>
      <div id="multiText" class="subline"></div>
      <div id="extraDupInfo" class="muted" style="margin-top:4px"></div>
    </div>

    <!-- ุงูููุฒุงุช ุงูุฐููุฉ -->
    <div class="card" id="advCard">
      <button id="advRunBtn" class="btn-green" style="width:100%;padding:14px;font-size:16px;font-weight:700;margin-bottom:12px">
        ุชูููุฐ (ุญุณุจ ุงููุชูุฌุฉ)
      </button>
      <div id="advNote" class="muted" style="margin-bottom:12px"></div>

      <div class="row" style="gap:8px; align-items:center">
        <label class="small" style="margin:0;min-width:60px">ุงููุฏู</label>
        <select id="sheetSelect" style="flex:1"></select>

        <label class="small" style="margin:0;min-width:70px">ุงูุชูููุฐ</label>
        <select id="targetMode" style="flex:1">
          <option value="agent">ุงููููู ููุท</option>
          <option value="both" selected>ุงูุฅุฏุงุฑุฉ + ุงููููู</option>
        </select>

        <button id="refreshSheetsBtn" class="btn-ghost" title="ุชุญุฏูุซ ูุงุฆูุฉ ุงูุฃูุฑุงู">โป</button>
      </div>

      <div class="row" style="margin-top:10px;gap:14px;flex-wrap:wrap">
        <div style="flex:1;display:flex;align-items:center;gap:8px">
          <input id="adminColor" type="color" value="#fde68a"
            style="width:38px;height:32px;border:1px solid var(--border);border-radius:8px;padding:0" />
          <label class="small" style="margin:0">ููู ุงูุฅุฏุงุฑุฉ</label>
        </div>
        <div style="flex:1;display:flex;align-items:center;gap:8px">
          <input id="withdrawColor" type="color" value="#ddd6fe"
            style="width:38px;height:32px;border:1px solid var(--border);border-radius:8px;padding:0" />
          <label class="small" style="margin:0">ููู ุณุญุจ ููุงูุฉ</label>
        </div>
      </div>

      <div class="row stretch" style="margin-top:10px">
        <input id="newSheetName" type="text" placeholder="ุงุณู ูุฑูุฉ ุฌุฏูุฏุฉ (ุฏุงุฎู ุงูุฅุฏุงุฑุฉ)">
        <button id="createSheetBtn" class="btn-ghost">ุฅูุดุงุก</button>
      </div>

      <div class="row" style="margin-top:12px; align-items:center; gap:12px; flex-wrap:wrap">
        <div class="row" style="gap:8px; align-items:center">
          <label class="small" style="margin:0">ุงูุฎุตู %</label>
          <input id="discountInput" type="number" min="0" max="100" value="0" step="1" style="width:110px">
        </div>

        <div class="toggle-chip">
          <span class="switch-label">ุงูุฎุตู ูุญุธููุง</span>
          <label class="ios-toggle">
            <input id="applyDiscountToMessage" type="checkbox">
            <span class="slider"></span>
          </label>
        </div>

        <div class="toggle-chip">
          <span class="switch-label">ุชุตุญูุญ ุงูุฑุงุชุจ</span>
          <label class="ios-toggle">
            <input id="enableSalaryCorrection" type="checkbox">
            <span class="slider"></span>
          </label>
        </div>
      </div>
      <div id="aiMountHere"></div>
      <div id="afterAiHook"></div>
    </div>

    <!-- ุจูุงูุงุช ุตุงุญุจ ุงููID -->
    <div class="card" id="personCard">
      <div class="row" style="justify-content:space-between; align-items:center">
        <strong>ุจูุงูุงุช ุตุงุญุจ ุงููID</strong>
        <div class="row" style="gap:6px; flex:0 0 auto">
          <button id="copyMsgBtn" class="btn-green">ูุณุฎ ุงูุฑุณุงูุฉ</button>
          <button id="colorAllBtn" class="btn-ghost" title="ุชูููู ูู ุงููIDs ููุฐุง ุงูุดุฎุต ุจุณุฑุนุฉ">ุชูููู ุงููู</button>
        </div>
      </div>
      <div id="personNote" class="muted" style="margin-top:6px">โ</div>
      <textarea id="personMsg" rows="8" style="width:100%; margin-top:8px; padding:10px; border:1px solid var(--border); border-radius:10px; font-family:inherit; font-size:14px" readonly></textarea>
    </div>

    <!-- ===== ุฃุฏูุงุช ุณุฑูุนุฉ (ุจุทุงูุงุช ูุณุชููุฉุ ููุณ ุงูู IDs ุงููุฏููุฉ) ===== -->
<style>
  /* ุดุจูุฉ ูุฑุชูุจุฉ ููุจุทุงูุงุชุ ุชุชูููู ูุน ุงูููุจุงูู */
  #quickTools.qtools-wrap{
    padding:0; background:transparent; border:0; box-shadow:none;
  }
  #qtGrid{
    display:grid; gap:10px;
    grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
  }
  #qtGrid .card{
    margin:0; /* ูููุน ุชูุฑุงุฑ ุงูููุงูุด */
  }

  /* ุนููุงู ุตุบูุฑ ุฃููู ุฏุงุฎู ูู ุจุทุงูุฉ (ุงุฎุชูุงุฑู) */
  .qt-title{
    font-size:14px; font-weight:800; margin:0 0 8px 0;
  }

  /* ุตู ุฏุงุฎูู ูุฑุชุจ */
  .qt-row{
    display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
  }

  /* ูุจุณ ุฒุฑ ุตุบูุฑ ููุนุฏุงุฏ */
  .qt-pill{
    display:flex; align-items:center; gap:8px; flex-wrap:wrap;
    border:1px solid var(--border); border-radius:12px; padding:8px 12px;
  }

  /* ูู ุงูููุจุงูู: ุนุฑุถ ูุงูู ุชููุงุฆู */
  @media (max-width:1059px){
    #qtGrid{ grid-template-columns: 1fr; }
    .qt-row .btn-ghost, .qt-row button, .qt-row label{ width:100%; }
    .qt-pill{ width:100%; justify-content:space-between; }
  }
</style>

<div id="quickTools" class="qtools-wrap card span2">
  <div id="qtGrid">

    <!-- ุจุทุงูุฉ: ุงููุถุน -->
    <div class="card" id="qtModeCard">
      <div class="qt-title">ุงููุถุน</div>
      <div class="qt-row">
        <button id="qtMode" class="btn-ghost">๐ ุชูุนูู ุงููุถุน ุงูุฏุงูู</button>
      </div>
    </div>

    <!-- ุจุทุงูุฉ: ุฅุฎูุงุก ุงูุชุญููู -->
    <div class="card" id="qtHideLoadCard">
      <div class="qt-title">ุงูุชุญููู</div>
      <div class="qt-row">
        <button id="qtHideLoad" class="btn-ghost">๐ ุฅุฎูุงุก ูุณู ุงูุชุญููู</button>
      </div>
    </div>

    <!-- ุจุทุงูุฉ: ูุณู ุงูุจูุงูุงุช -->
    <div class="card" id="qtPersonCard">
      <div class="qt-title">ูุณู ุงูุจูุงูุงุช</div>
      <div class="qt-row" style="gap:8px">
        <button id="qtHidePerson" class="btn-ghost">๐ ุฅุฎูุงุก ูุณู ุงูุจูุงูุงุช</button>
        <label class="ios-toggle" style="margin-inline-start:6px">
          <span class="switch-label">ุชุนุทูู ูุณู ุงูุจูุงูุงุช</span>
          <input id="qtDisablePerson" type="checkbox">
          <span class="slider"></span>
        </label>
      </div>
    </div>

    <!-- ุจุทุงูุฉ: ุงูุนุฏูุงุฏ -->
    <div class="card" id="qtCounterCard">
      <div class="qt-title">ุงูุนุฏูุงุฏ</div>
      <div class="qt-row">
        <div class="qt-pill" style="flex:1">
          <span class="muted">ุงูููููู:</span><b id="qtColored">โ</b>
          <span style="width:10px"></span>
          <span class="muted">ุบูุฑ ุงูููููู:</span><b id="qtUncolored">โ</b>
        </div>
        <button id="qtRefreshCnt" class="btn-ghost" title="ุชุญุฏูุซ ุงูุนุฏูุงุฏ">โป ุชุญุฏูุซ</button>
      </div>
    </div>

  </div>

    <!-- ุฃุฏุงุฉ ุงูุจุญุซ ุงูุฌูุงุนู -->
    <div class="card span2" id="bulkCard">
      <div class="bulk-header">
        <strong>ุฃุฏุงุฉ ุงูุจุญุซ ุงูุฌูุงุนู</strong>
        <div id="bulkStatus" class="muted">โ</div>
      </div>
      <div class="bulk-section">
        <label class="small" for="bulkScope">ุงุฎุชูุงุฑ ุงููุทุงู</label>
        <select id="bulkScope">
          <option value="agent">ุงููููู ููุท</option>
          <option value="both">ุงูุฅุฏุงุฑุฉ + ุงููููู</option>
          <option value="all">ุงููู ููุดูู ุดูุช ุฎุงุฑุฌู</option>
        </select>
      </div>
      <div class="bulk-section" id="bulkSheetWrap">
        <label class="small" for="bulkSheetSelect">ุงุฎุชูุงุฑ ุงููุฑูุฉ</label>
        <div class="row stretch" style="gap:8px;flex-wrap:wrap;align-items:stretch;">
          <select id="bulkSheetSelect" style="flex:2 1 180px;min-width:160px"></select>
          <input id="bulkSheetNew" type="text" placeholder="ุงุณู ูุฑูุฉ ุฌุฏูุฏุฉ" style="flex:1 1 150px;min-width:140px">
          <button id="bulkCreateSheetBtn" class="btn-ghost" style="flex:0 0 auto;min-width:120px">ุฅูุดุงุก ูุฑูุฉ</button>
        </div>
      </div>
      <div class="row" style="gap:12px;flex-wrap:wrap;align-items:flex-end">
        <div style="flex:1 1 160px;min-width:140px">
          <label class="small" for="bulkColor">ุฃุฏุงุฉ ุงุฎุชูุงุฑ ุงูููู</label>
          <input id="bulkColor" type="color" value="#34c759" style="width:100%;height:44px;border-radius:12px;border:1px solid var(--border);background:transparent;padding:4px">
        </div>
        <div style="flex:1 1 160px;min-width:140px">
          <label class="small" for="bulkDiscount">ูุณุจุฉ ุฎุตู (%)</label>
          <input id="bulkDiscount" type="number" min="0" max="100" step="1" value="0">
        </div>

      </div>
      <div class="bulk-section">
        <label class="small" for="bulkIds">ุฃูุตู ุนุฏุฉ IDs</label>
        <textarea id="bulkIds" class="bulk-textarea" placeholder="ุงูุตู IDs ููุตููุฉ ุจุณุทุฑุ ูุงุตูุฉ ุฃู ูุณุงูุฉ"></textarea>
      </div>
      <div class="bulk-buttons">
        <button id="bulkPasteBtn" class="btn-blue">ูุตู ุซู ุจุญุซ</button>
        <button id="bulkAnalyzeBtn" class="btn-green">ุชุญููู</button>
        <button id="bulkExecuteBtn" class="btn-blue">ุชูููุฐ ุงููู</button>
      </div>
      <div class="bulk-buttons" style="margin-top:6px">
        <button id="bulkCopyAllBtn" class="btn-ghost">ูุณุฎ ุงููู</button>
        <button id="bulkCopySalaryBtn" class="btn-ghost">ูุณุฎ ุงูุฑูุงุชุจ ููุท</button>
        <button id="bulkResetBtn" class="btn-red">ุฅุนุงุฏุฉ ุชุนููู</button>
      </div>
      <div id="bulkNote" class="muted">โ</div>
      <div class="bulk-progress">
        <div id="bulkProgressBar" class="bulk-progress__bar"></div>
      </div>
      <div class="bulk-metrics">
        <div><span>ูุณุจุฉ ุงูุฅูุฌุงุฒ</span><b id="bulkProgressPct">0%</b></div>
        <div><span>ุนุฏุฏ ุงูุฅุฏุฎุงูุงุช</span><b id="bulkTotalCount">0</b></div>
        <div><span>ุนุฏุฏ ุงูููููููู</span><b id="bulkColoredCount">0</b></div>
        <div><span>ุบูุฑ ุงูููููููู</span><b id="bulkUncoloredCount">0</b></div>
        <div><span>ูุฌููุน ุงูุฑูุงุชุจ</span><b id="bulkSalaryTotal">0</b></div>
      </div>
      <div class="bulk-table-wrap">
        <table id="bulkResultsTable">
          <thead>
            <tr>
              <th>#</th>
              <th>ID</th>
              <th>ุงูุฑุงุชุจ</th>
              <th>ุงูุญุงูุฉ</th>
              <th>ูููููุ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  <script>
    // ุนูุงุตุฑ ุนุงูุฉ
    const reloadBtn      = document.getElementById('reloadBtn');
    const loadNote       = document.getElementById('loadNote');

    const idInput        = document.getElementById('idInput');
    const pasteSearchBtn = document.getElementById('pasteSearchBtn');
    const pasteHint      = document.getElementById('pasteHint');

    const resultsBox  = document.getElementById('resultsBox');
    const statusBadge = document.getElementById('statusBadge');
    const dupBadge    = document.getElementById('dupBadge');
    const amountText  = document.getElementById('amountText');
    const multiText   = document.getElementById('multiText');
    const extraDupInfo= document.getElementById('extraDupInfo');
    const justColored = Object.create(null);
    
    // ุนูุตุฑ ูุนุฑุถ ุงุณู ุงูุนููู (ูู ุนููุฏ B)
    const nameText   = document.getElementById('nameText');
const advCard  = document.getElementById('advCard');
    const advNote  = document.getElementById('advNote');
    const sheetSelect   = document.getElementById('sheetSelect');
    const refreshSheetsBtn = document.getElementById('refreshSheetsBtn');
    const newSheetName  = document.getElementById('newSheetName');
    const createSheetBtn= document.getElementById('createSheetBtn');
    const adminColor    = document.getElementById('adminColor');
    const withdrawColor = document.getElementById('withdrawColor');
    const targetModeSel = document.getElementById('targetMode');
    const advRunBtn     = document.getElementById('advRunBtn');

    const discountInput = document.getElementById('discountInput');
    const applyDiscountToMessage = document.getElementById('applyDiscountToMessage');
    const enableSalaryCorrection = document.getElementById('enableSalaryCorrection');

    // ุจุทุงูุฉ ุงูุดุฎุต
    const personCardEl = document.getElementById('personCard');
    const personNote   = document.getElementById('personNote');
    const personMsg    = document.getElementById('personMsg');
    const copyMsgBtn   = document.getElementById('copyMsgBtn');
    const colorAllBtn  = document.getElementById('colorAllBtn');

    // ุขุฎุฑ ID
    const lastIdPill = document.getElementById('lastIdPill');
    const lastIdText = document.getElementById('lastIdText');

    // ุฃุฏูุงุช ุณุฑูุนุฉ
    const qtColored = document.getElementById('qtColored');
    const qtUncolored = document.getElementById('qtUncolored');
    const qtMode = document.getElementById('qtMode');
    const qtHide = document.getElementById('qtHideLoad');

    const qtHidePerson = document.getElementById('qtHidePerson');
    const qtDisablePerson = document.getElementById('qtDisablePerson');

    // ุฃุฏุงุฉ ุงูุจุญุซ ุงูุฌูุงุนู
    const bulkCardEl          = document.getElementById('bulkCard');
    const bulkStatusEl        = document.getElementById('bulkStatus');
    const bulkScopeSel        = document.getElementById('bulkScope');
    const bulkSheetWrap       = document.getElementById('bulkSheetWrap');
    const bulkSheetSelect     = document.getElementById('bulkSheetSelect');
    const bulkSheetNew        = document.getElementById('bulkSheetNew');
    const bulkCreateSheetBtn  = document.getElementById('bulkCreateSheetBtn');
    const bulkColorInput      = document.getElementById('bulkColor');
    const bulkDiscountInput   = document.getElementById('bulkDiscount');
    const bulkApplyDiscount   = document.getElementById('bulkApplyDiscount');
    const bulkIdsTextarea     = document.getElementById('bulkIds');
    const bulkPasteBtn        = document.getElementById('bulkPasteBtn');
    const bulkAnalyzeBtn      = document.getElementById('bulkAnalyzeBtn');
    const bulkExecuteBtn      = document.getElementById('bulkExecuteBtn');
    const bulkCopyAllBtn      = document.getElementById('bulkCopyAllBtn');
    const bulkCopySalaryBtn   = document.getElementById('bulkCopySalaryBtn');
    const bulkResetBtn        = document.getElementById('bulkResetBtn');
    const bulkNoteEl          = document.getElementById('bulkNote');
    const bulkProgressBar     = document.getElementById('bulkProgressBar');
    const bulkProgressPctEl   = document.getElementById('bulkProgressPct');
    const bulkTotalCountEl    = document.getElementById('bulkTotalCount');
    const bulkColoredCountEl  = document.getElementById('bulkColoredCount');
    const bulkUncoloredCountEl= document.getElementById('bulkUncoloredCount');
    const bulkSalaryTotalEl   = document.getElementById('bulkSalaryTotal');
    const bulkResultsBody     = document.querySelector('#bulkResultsTable tbody');

    // ุญุงูุฉ
    let localMap = null;
    let lastResult = null;
    let lastProfileIds = [];
    let lastBaseId = '';

    const fmt = n => {
      const x = Number(n);
      return isNaN(x) ? 'โ' : new Intl.NumberFormat('en-US', { maximumFractionDigits: 2 }).format(x);
    };

    /******** ุฃุฏุงุฉ ุงูุจุญุซ ุงูุฌูุงุนู ********/
    const bulkState = {
      ids: [],
      results: [],
      stats: { total:0, colored:0, uncolored:0, sum:0, discount:0, afterDiscount:0, percent:0 },
      running: false
    };

    function clampPercent(v){
      const num = Number(v);
      if (isNaN(num)) return 0;
      return Math.max(0, Math.min(100, num));
    }
    function dedupeIdsKeepOrder(arr){
      const seen = Object.create(null);
      const out = [];
      (arr||[]).forEach(id=>{
        const v = String(id||'').trim();
        if (!v || seen[v]) return;
        seen[v] = 1;
        out.push(v);
      });
      return out;
    }
    function parseBulkIds(txt){
      if (!txt) return [];
      return dedupeIdsKeepOrder(String(txt).split(/[\s,ุุ]+/));
    }
    function setBulkStatus(text){ if (bulkStatusEl) bulkStatusEl.textContent = text || 'โ'; }
    function setBulkNote(text){ if (bulkNoteEl) bulkNoteEl.textContent = text || 'โ'; }
    function setBulkProgress(pct){
      if (!bulkProgressBar || !bulkProgressPctEl) return;
      const val = Math.max(0, Math.min(100, Number(pct)||0));
      bulkProgressBar.style.width = val + '%';
      bulkProgressPctEl.textContent = Math.round(val) + '%';
    }
    function resetBulkStats(){
      bulkState.stats = { total:0, colored:0, uncolored:0, sum:0, discount:0, afterDiscount:0, percent:0 };
    }
    function renderBulkStats(){
      const st = bulkState.stats || {};
      if (bulkTotalCountEl)    bulkTotalCountEl.textContent    = fmt(st.total || 0);
      if (bulkColoredCountEl)  bulkColoredCountEl.textContent  = fmt(st.colored || 0);
      if (bulkUncoloredCountEl)bulkUncoloredCountEl.textContent= fmt(st.uncolored || 0);

      if (bulkSalaryTotalEl){
        const sum = Number(st.sum || 0);
        const discount = Number(st.discount || 0);
        const after = Number(st.afterDiscount || sum);
        if (bulkApplyDiscount && bulkApplyDiscount.checked){
          const base = fmt(after);
          bulkSalaryTotalEl.textContent = discount ? `${base} (ุฎุตู ${fmt(discount)})` : base;
        } else {
          const base = fmt(sum);
          bulkSalaryTotalEl.textContent = discount ? `${base} (ุจุนุฏ ุงูุฎุตู ${fmt(after)})` : base;
        }
      }

      setBulkProgress(typeof st.percent === 'number' ? st.percent : 0);
    }
    function renderBulkTable(rows){
      if (!bulkResultsBody) return;
      bulkResultsBody.innerHTML = '';
      const useDiscount = !!(bulkApplyDiscount && bulkApplyDiscount.checked);
      if (!Array.isArray(rows) || !rows.length){
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 5;
        td.textContent = 'ูุง ุชูุฌุฏ ูุชุงุฆุฌ ุจุนุฏ.';
        td.style.textAlign = 'center';
        td.style.padding = '18px';
        tr.appendChild(td);
        bulkResultsBody.appendChild(tr);
        return;
      }
      rows.forEach(row=>{
        const tr = document.createElement('tr');
        const colored = !!(row && (row.coloredAgent || row.coloredAdmin));
        const cells = [
          row?.index || '',
          row?.id || '',
          useDiscount ? fmt(row?.salaryAfterDiscount) : fmt(row?.salary),
          row?.status || '',
          colored ? 'ูุนู' : 'ูุง'
        ];
        cells.forEach((val, idx)=>{
          const td = document.createElement('td');
          td.textContent = val === undefined ? '' : val;
          if (idx === 4) td.style.textAlign = 'center';
          tr.appendChild(td);
        });
        if (colored) tr.classList.add('bulk-row-colored');
        bulkResultsBody.appendChild(tr);
      });
    }
    function ensureBulkSheetVisibility(){
      if (!bulkSheetWrap || !bulkScopeSel) return;
      const scope = (bulkScopeSel.value || 'agent').toLowerCase();
      bulkSheetWrap.style.display = (scope === 'all') ? '' : 'none';
    }
    function collectBulkIds(){
      const ids = parseBulkIds(bulkIdsTextarea ? bulkIdsTextarea.value : '');
      bulkState.ids = ids;
      return ids;
    }
    async function readClipboardSafe(){
      if (navigator.clipboard && navigator.clipboard.readText){
        try {
          const txt = await navigator.clipboard.readText();
          if (txt && txt.trim()) return txt;
        } catch(_){}
      }
      return null;
    }
    async function copyTextSafe(txt){
      if (!txt) return false;
      if (navigator.clipboard && navigator.clipboard.writeText){
        try { await navigator.clipboard.writeText(txt); return true; }
        catch(_){}
      }
      try {
        const manual = prompt('ุงูุณุฎ ูุฏูููุง ุซู ุงุถุบุท ููุงูู:', txt);
        return !!manual;
      } catch(_) {
        return false;
      }
    }
    function setBulkRunning(flag, statusText){
      bulkState.running = !!flag;
      const btns = [bulkPasteBtn, bulkAnalyzeBtn, bulkExecuteBtn, bulkCopyAllBtn, bulkCopySalaryBtn, bulkResetBtn, bulkCreateSheetBtn];
      btns.forEach(btn=>{ if (btn) btn.disabled = !!flag; });
      if (statusText) setBulkStatus(statusText);
      else setBulkStatus(flag ? 'ุฌุงุฑู ุงููุนุงูุฌุฉโฆ' : 'ุฌุงูุฒ');
    }
    function handleBulkResponse(res, source){
      if (!res || res.ok !== true){
        setBulkNote(res?.message || 'โ๏ธ ุญุฏุซ ุฎุทุฃ.');
        setBulkStatus('โ๏ธ');
        resetBulkStats();
        renderBulkStats();
        renderBulkTable([]);
        setBulkProgress(0);
        return;
      }
      bulkState.results = Array.isArray(res.results) ? res.results : [];
      bulkState.stats = Object.assign({ total:0, colored:0, uncolored:0, sum:0, discount:0, afterDiscount:0, percent:0 }, res.stats||{});
      setBulkNote(res.message || (source === 'execute' ? 'ุชู ุงูุชูููุฐ โ' : 'ุชู ุงูุชุญููู โ'));
      setBulkStatus(res.message || (source === 'execute' ? 'ุชู ุงูุชูููุฐ' : 'ุชู ุงูุชุญููู'));
      renderBulkStats();
      renderBulkTable(bulkState.results);
      if (source === 'execute'){ // ุญุฏูุซ ุงูุฐุงูุฑุฉ ุงููุญููุฉ ูุญุงุฑุณ ุงูุชูุฑุงุฑ
        bulkState.results.forEach(row=>{
          const id = String(row?.id||'').trim();
          if (!id) return;
          if (row.coloredAgent || row.coloredAdmin){
            justColored[id] = (row.coloredAgent && row.coloredAdmin) ? 'both' : (row.coloredAgent ? 'agent' : 'admin');
          }
          if (localMap && localMap[id]){
            if (row.coloredAgent) localMap[id].aCol = true;
            if (row.coloredAdmin) localMap[id].dCol = true;
          }
        });
        refreshCountsLive();
      }
    }
    function resetBulkTool(){
      if (bulkIdsTextarea) bulkIdsTextarea.value = '';
      bulkState.ids = [];
      bulkState.results = [];
      resetBulkStats();
      renderBulkStats();
      renderBulkTable([]);
      setBulkProgress(0);
      setBulkNote('ุชูุช ุฅุนุงุฏุฉ ุงูุชุนููู.');
      setBulkStatus('โ');
    }
    function buildBulkCopyText(mode){
      if (!Array.isArray(bulkState.results) || !bulkState.results.length) return '';
      const useDiscount = !!(bulkApplyDiscount && bulkApplyDiscount.checked);
      return bulkState.results.map(row=>{
        const base = useDiscount ? Number(row?.salaryAfterDiscount||0) : Number(row?.salary||0);
        const salaryText = base.toFixed(2);
        if (mode === 'salary'){
          return `${row?.id || ''}\t${salaryText}`;
        }
        return `${row?.id || ''}\t${salaryText}\t${row?.status || ''}`;
      }).join('\n');
    }
    function triggerBulkAnalyze(){
      const ids = collectBulkIds();
      if (!ids.length){ setBulkNote('โ๏ธ ุฃุถู IDs ุฃููุงู.'); setBulkStatus('ุฌุงูุฒ'); return; }
      setBulkRunning(true, 'ุฌุงุฑู ุงูุชุญูููโฆ');
      setBulkNote('ุฌุงุฑู ุงูุชุญูููโฆ');
      setBulkProgress(8);
      const discount = clampPercent(bulkDiscountInput ? bulkDiscountInput.value : 0);
      google.script.run
        .withSuccessHandler(res=>{ setBulkRunning(false); handleBulkResponse(res, 'analyze'); })
        .withFailureHandler(err=>{
          setBulkRunning(false);
          setBulkStatus('โ๏ธ');
          setBulkNote('ุฎุทุฃ: ' + (err?.message || '')); setBulkProgress(0);
        })
        .bulkSearchExact(ids, discount);
    }
    function triggerBulkExecute(){
      const ids = collectBulkIds();
      if (!ids.length){ setBulkNote('โ๏ธ ุฃุถู IDs ุฃููุงู.'); setBulkStatus('ุฌุงูุฒ'); return; }
      const scope = (bulkScopeSel?.value || 'agent').toLowerCase();
      if (scope === 'all'){ const name = String(bulkSheetSelect?.value || '').trim(); if (!name){ setBulkNote('โ๏ธ ุงุฎุชุฑ ูุฑูุฉ ููุชุตุฏูุฑ.'); return; } }
      setBulkRunning(true, 'ุฌุงุฑู ุงูุชูููุฐโฆ');
      setBulkNote('ุฌุงุฑู ุงูุชูููุฐโฆ');
      setBulkProgress(12);
      const payload = {
        scope: scope,
        sheetName: bulkSheetSelect ? bulkSheetSelect.value : '',
        color: bulkColorInput ? bulkColorInput.value : '#34c759',
        discount: clampPercent(bulkDiscountInput ? bulkDiscountInput.value : 0),
        applyDiscount: !!(bulkApplyDiscount && bulkApplyDiscount.checked)
      };
      google.script.run
        .withSuccessHandler(res=>{ setBulkRunning(false); handleBulkResponse(res, 'execute'); })
        .withFailureHandler(err=>{
          setBulkRunning(false);
          setBulkStatus('โ๏ธ');
          setBulkNote('ุฎุทุฃ: ' + (err?.message || ''));
          setBulkProgress(0);
        })
        .bulkExecuteExact(ids, payload);
    }
    function loadBulkSheets(selectName){
      if (!bulkSheetSelect) return;
      bulkSheetSelect.innerHTML = '';
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = 'โ';
      bulkSheetSelect.appendChild(placeholder);
      google.script.run
        .withSuccessHandler(list=>{
          bulkSheetSelect.innerHTML = '';
          const names = Array.isArray(list) ? list : [];
          if (!names.length){
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'ูุง ุชูุฌุฏ ุฃูุฑุงู';
            bulkSheetSelect.appendChild(opt);
            return;
          }
          names.forEach(name=>{
            const opt = document.createElement('option');
            opt.value = opt.textContent = name;
            bulkSheetSelect.appendChild(opt);
          });
          if (selectName){
            const found = Array.from(bulkSheetSelect.options).find(o=>o.value === selectName);
            if (found) bulkSheetSelect.value = selectName;
          }
        })
        .withFailureHandler(()=>{
          bulkSheetSelect.innerHTML = '';
          const opt = document.createElement('option');
          opt.value=''; opt.textContent='โ๏ธ ุชุนุฐูุฑ ุงูุชุญููู';
          bulkSheetSelect.appendChild(opt);
        })
        .listSheets();
    }

    ensureBulkSheetVisibility();
    loadBulkSheets();
    resetBulkStats();
    renderBulkStats();
    renderBulkTable([]);
    setBulkProgress(0);

    if (bulkScopeSel) bulkScopeSel.addEventListener('change', ensureBulkSheetVisibility);
    if (bulkPasteBtn) bulkPasteBtn.addEventListener('click', async ()=>{
      setBulkNote('ุฌุงุฑู ูุฑุงุกุฉ ุงูุญุงูุธุฉโฆ');
      let txt = await readClipboardSafe();
      if (!txt){
        try { txt = prompt('ุงูุตู IDs ููุง:') || ''; }
        catch(_) { txt = ''; }
      }
      txt = (txt || '').trim();
      if (!txt){ setBulkNote('โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ูุต.'); setBulkStatus('ุฌุงูุฒ'); return; }
      if (bulkIdsTextarea) bulkIdsTextarea.value = txt;
      triggerBulkAnalyze();
    });
    if (bulkAnalyzeBtn) bulkAnalyzeBtn.addEventListener('click', triggerBulkAnalyze);
    if (bulkExecuteBtn) bulkExecuteBtn.addEventListener('click', triggerBulkExecute);
    if (bulkCopyAllBtn) bulkCopyAllBtn.addEventListener('click', async ()=>{
      const txt = buildBulkCopyText('full');
      if (!txt){ setBulkNote('โ๏ธ ูุง ููุฌุฏ ุจูุงูุงุช ููุณุฎูุง.'); return; }
      const ok = await copyTextSafe(txt);
      setBulkNote(ok ? 'โ ุชู ูุณุฎ ุงููุชูุฌุฉ (ID + ุงูุฑุงุชุจ + ุงูุญุงูุฉ).' : 'โ๏ธ ุชุนุฐูุฑ ุงููุณุฎ.');
    });
    if (bulkCopySalaryBtn) bulkCopySalaryBtn.addEventListener('click', async ()=>{
      const txt = buildBulkCopyText('salary');
      if (!txt){ setBulkNote('โ๏ธ ูุง ููุฌุฏ ุจูุงูุงุช ููุณุฎูุง.'); return; }
      const ok = await copyTextSafe(txt);
      setBulkNote(ok ? 'โ ุชู ูุณุฎ ุงูุฑูุงุชุจ.' : 'โ๏ธ ุชุนุฐูุฑ ุงููุณุฎ.');
    });
    if (bulkResetBtn) bulkResetBtn.addEventListener('click', resetBulkTool);
    if (bulkApplyDiscount) bulkApplyDiscount.addEventListener('change', ()=>{
      renderBulkStats();
      renderBulkTable(bulkState.results);
    });
    if (bulkDiscountInput) bulkDiscountInput.addEventListener('change', ()=>{
      const clamped = clampPercent(bulkDiscountInput.value);
      bulkDiscountInput.value = clamped;
      setBulkNote('โน๏ธ ุฃุนุฏ ุงูุชุญููู ูุชุทุจูู ุงูุฎุตู ุงูุฌุฏูุฏ.');
    });
    if (bulkCreateSheetBtn) bulkCreateSheetBtn.addEventListener('click', ()=>{
      const name = String(bulkSheetNew?.value || '').trim();
      if (!name){ setBulkNote('โ๏ธ ุงูุชุจ ุงุณู ูุฑูุฉ ุฌุฏูุฏุฉ.'); return; }
      bulkCreateSheetBtn.disabled = true;
      google.script.run
        .withSuccessHandler(res=>{
          bulkCreateSheetBtn.disabled = false;
          const msg = res?.message || 'ุชู ุฅูุดุงุก ุงููุฑูุฉ โ';
          setBulkNote(msg);
          const newName = res?.name || name;
          if (bulkSheetNew) bulkSheetNew.value = '';
          loadBulkSheets(newName);
        })
        .withFailureHandler(err=>{
          bulkCreateSheetBtn.disabled = false;
          setBulkNote('ุฎุทุฃ: ' + (err?.message || ''));
        })
        .createSheetIfMissing(name);
    });

    /******** ูุณู ุงูุจูุงูุงุช (ุฅุฎูุงุก/ุชุนุทูู) ********/
    function isPersonFeatureDisabled(){ return localStorage.getItem('disable_person_feature') === '1'; }
    function isPersonHidden(){ return localStorage.getItem('hide_person_section') === '1'; }

    function applyPersonVisibility(){
      qtDisablePerson.checked = isPersonFeatureDisabled();
      const hidden = isPersonHidden() || isPersonFeatureDisabled();
      personCardEl.style.display = hidden ? 'none' : '';
      if (isPersonFeatureDisabled()){
        personMsg.value = '';
        personNote.textContent = 'โ';
        copyMsgBtn.disabled = true;
        colorAllBtn.disabled = true;
      } else {
        copyMsgBtn.disabled = false;
        colorAllBtn.disabled = false;
      }
      qtHidePerson.textContent = hidden ? '๐ ุฅุธูุงุฑ ูุณู ุงูุจูุงูุงุช' : '๐ ุฅุฎูุงุก ูุณู ุงูุจูุงูุงุช';
    }
    qtHidePerson.addEventListener('click', ()=>{
      const cur = isPersonHidden();
      localStorage.setItem('hide_person_section', cur ? '0':'1');
      applyPersonVisibility();
    });
    qtDisablePerson.addEventListener('change', ()=>{
      const en = !!qtDisablePerson.checked;
      localStorage.setItem('disable_person_feature', en ? '1':'0');
      applyPersonVisibility();
    });

    /******** ุฃุฏูุงุช ูุณุงุนุฏุฉ UI ********/
    function flash(el, cls){
      el.classList.remove('flash-blue','flash-green');
      void el.offsetWidth;
      el.classList.add(cls);
    }
    function saveLastId(id){
      try { localStorage.setItem('last_id', id); } catch(_){}
      lastIdText.textContent = id || '';
      lastIdPill.style.display = id ? 'inline-flex' : 'none';
    }
    function loadLastId(){
      let v = '';
      try { v = localStorage.getItem('last_id') || ''; } catch(_){}
      if (v){ lastIdText.textContent = v; lastIdPill.style.display = 'inline-flex'; }
      else { lastIdPill.style.display = 'none'; }
    }
    lastIdPill.addEventListener('click', ()=>{
      const v = lastIdText.textContent || '';
      if (!v) return;
      idInput.value = v;
      doSearch();
    });

    /******** ุชุญููู ุงูุฃูุฑุงู ********/
    function fillSheets(){
      google.script.run
        .withSuccessHandler(arr=>{
          sheetSelect.innerHTML = '';
          (arr||[]).forEach(n=>{
            const o = document.createElement('option');
            o.value = o.textContent = n;
            sheetSelect.appendChild(o);
          });
        })
        .withFailureHandler(err=> advNote.textContent = 'ุฎุทุฃ: '+(err?.message||'')) 
        .getAdminSheets();
    }

    /******** ุชุญููู ุงูุจูุงูุงุช ********/
    function setLoadBtnState(ok){
      if (ok===true){ reloadBtn.classList.remove('btn-red'); reloadBtn.classList.add('btn-green'); }
      else if (ok===false){ reloadBtn.classList.remove('btn-green'); reloadBtn.classList.add('btn-red'); }
    }
    function loadData(){
      setLoadBtnState(false);
      loadNote.textContent = 'โณ ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุชโฆ';
      google.script.run
        .withSuccessHandler(srv=>{
          const baseMsg = srv?.message || 'ุชู ุงูุชุญููู ูู ุงูุณูุฑูุฑ.';
          google.script.run
            .withSuccessHandler(res=>{
              if(!res || !res.ok){
                loadNote.textContent = baseMsg + ' | โ๏ธ ูุดู ุงููุญูู: ' + (res?.message||'');
                setLoadBtnState(false);
                return;
              }
              localMap = res.map || null;
              const st = res.stats || {};
              loadNote.textContent = `${baseMsg} | ูุญูู: ${st.agentRows||0} ุตู / ${st.agentUnique||0} ID.`;
              setLoadBtnState(true);
              refreshCountsLive();
            })
            .withFailureHandler(err=>{
              loadNote.textContent = baseMsg + ' | โ๏ธ ุฎุทุฃ ุจุงููุญูู: ' + (err?.message||'');
              setLoadBtnState(false);
            })
            .getSearchSnapshotLight();
        })
        .withFailureHandler(err=>{
          loadNote.textContent = 'โ๏ธ ุฎุทุฃ ุจุงูุชุญููู: ' + (err?.message||'');
          setLoadBtnState(false);
        })
        .loadDataIntoCache();
    }
    reloadBtn.addEventListener('click', loadData);
    createSheetBtn.addEventListener('click', ()=>{
  const name = (newSheetName.value || '').trim();
  if (!name){ advNote.textContent = 'โ๏ธ ุงูุชุจ ุงุณู ูุฑูุฉ ุฌุฏูุฏุฉ'; return; }
  google.script.run
    .withSuccessHandler(msg=>{
      advNote.textContent = msg || 'ุชู ุงูุฅูุดุงุก โ';
      // ุญุฏูุซ ุงููุงุฆูุฉ ูุญุฏูุฏ ุงููุฑูุฉ ุงูุฌุฏูุฏุฉ
      google.script.run
        .withSuccessHandler(arr=>{
          sheetSelect.innerHTML = '';
          (arr||[]).forEach(n=>{
            const o = document.createElement('option');
            o.value = o.textContent = n;
            sheetSelect.appendChild(o);
          });
          // ุญุงูู ุงุฎุชูุงุฑ ุงููุฑูุฉ ุงูุชู ุฃูุดุฃูุงูุง
          const opt = Array.from(sheetSelect.options).find(o => o.value === name);
          if (opt) sheetSelect.value = name;
          newSheetName.value = '';
        })
        .getAdminSheets();
    })
    .withFailureHandler(err=>{
      advNote.textContent = 'ุฎุทุฃ: ' + (err?.message || '');
    })
    .createAdminSheet(name);
});

    /******** ูุตู ุซู ุจุญุซ / ุฅูุชุฑ ********/
    pasteSearchBtn.addEventListener('click', async ()=>{
      pasteHint.textContent = '';
      try{
        const txt = await navigator.clipboard.readText();
        if (txt && txt.trim()){
          idInput.value = txt.trim();
          doSearch();
          return;
        }
      }catch(_){}
      idInput.focus(); idInput.select();
      pasteHint.textContent = 'ุงูุตู ูุฏูููุง ูุณูุจุฏุฃ ุงูุจุญุซ ุชููุงุฆููุงโฆ';
      const once = ()=>{ pasteHint.textContent = ''; idInput.removeEventListener('input', once); setTimeout(doSearch, 0); };
      idInput.addEventListener('input', once, { once:true });
    });
    idInput.addEventListener('paste', ()=> setTimeout(doSearch, 0));
    idInput.addEventListener('keyup', e=>{ if (e.key === 'Enter') doSearch(); });

    /******** ุฑูุฏุฑ ุงููุชุงุฆุฌ ********/
    function clearDupUI(){
      dupBadge.style.display = 'none';
      dupBadge.textContent = 'ููุฑุฑ';
      extraDupInfo.textContent = '';
    }
    function renderLoading(){
      clearDupUI();
      statusBadge.className = 'badge badge--loading';
      statusBadge.textContent = 'ุฌุงุฑู ุงูุจุญุซโฆ';
      amountText.textContent = 'โณ';
      multiText.textContent = '';
      if (nameText) nameText.textContent = 'โ';
    }
    function applyBadges(baseStatus, duplicateLabel, hasSalaries){
      let baseClass = 'badge--agent';
      if (baseStatus.includes('ุงุฏุงุฑุฉ') && !hasSalaries) baseClass = 'badge--admin';
      else if (baseStatus.includes('ุณุญุจ ููุงูุฉ'))      baseClass = 'badge--withdraw';
      else if (baseStatus.includes('ุบูุฑ ููุฌูุฏ'))      baseClass = 'badge--missing';
      statusBadge.className = 'badge ' + baseClass;
      statusBadge.textContent = baseStatus || 'โ';
      if (duplicateLabel){ dupBadge.style.display='inline-block'; dupBadge.textContent=duplicateLabel; }
      else dupBadge.style.display='none';
    }
    function renderResult(res){
      lastResult = res;
      
      // ุญุฏูุฏ ุงุณู ุงูุดุฎุต ุฅู ูุฌุฏ ูู ุงููุชูุฌุฉ (ุฅูุง ุฎุงุตูุฉ name ุฃู ุฏูุฌ ูุตูููุฉ names)
      (function(){ 
        try{
          let nm = '';
          if (res) {
            if (res.name) nm = String(res.name||'').trim();
            else if (Array.isArray(res.names)) nm = res.names.map(x=>String(x||'').trim()).filter(Boolean).join('ุ ');
          }
          if (nameText) nameText.textContent = nm || 'โ';
        }catch(_){ if (nameText) nameText.textContent = 'โ'; }
      })();
if (res.status === 'error'){ applyBadges('ุฎุทุฃ', null, false); amountText.textContent='โ'; multiText.textContent=res.message||''; return; }
      if (res.status === 'ุบูุฑ ููุฌูุฏ'){ applyBadges('ุบูุฑ ููุฌูุฏ', null, false); amountText.textContent='โ'; multiText.textContent=''; return; }

      const baseStatus = res.status || '';
      const dupLabel   = (res.isDuplicate && res.duplicateLabel) ? res.duplicateLabel : null;

      const hasSalaries = Array.isArray(res.salaries) && res.salaries.length > 0;
      const isAdminOnly = baseStatus.includes('ุงุฏุงุฑุฉ') && !hasSalaries;

      applyBadges(baseStatus, dupLabel, hasSalaries);

      if (isAdminOnly){ amountText.textContent='โ'; multiText.textContent=''; flash(resultsBox,'flash-blue'); return; }

      const total = Number(res.totalSalary)||0;
      const pct   = Math.max(0, Math.min(100, Number(discountInput.value)||0));
      amountText.textContent = fmt(total * (1 - pct/100));

      if (hasSalaries && res.salaries.length > 1){
        multiText.textContent = '(' + res.salaries.map(n=>fmt(Number(n)||0)).join(' + ') + ')';
      } else multiText.textContent = '';

      flash(resultsBox,'flash-blue');
    }

    /******** ุงูุฑุณุงูุฉ ********/
    function buildMessageText(card, applyDiscount, localMapRef){
      if (!card || !Array.isArray(card.ids)) return 'โ';
      const pct = Math.max(0, Math.min(100, Number(discountInput.value)||0));
      const lm  = localMapRef || {};
      const header = [];
      if (card.name)    header.push(card.name);
      if (card.phone)   header.push(card.phone);
      if (card.address) header.push(card.address);
      if (card.agency)  header.push(card.agency);
      if (card.note)    header.push('ููุงุญุธุฉ : ' + card.note);

      let total = 0;
      const idLines = [];
      card.ids.forEach(x=>{
        const id = String(x.id||'').trim();
        if (!id) return;
        const node = lm[id];
        const adminOnly = node ? (!node.rowsCount && node.inAdmin) : false;
        let val = Number(x.amount||0);
        if (applyDiscount) val = val * (pct ? (1 - pct/100) : 1);
        total += val;
        idLines.push({ id, text: `${id} ... ${fmt(val)}${adminOnly ? ' ุงุฏุงุฑุฉ' : ''}`, value: val });
      });

      const lines = [];
      lines.push(header.join('\n')); lines.push('');
      if (idLines.length === 1){
        lines.push(idLines[0].id); lines.push(''); lines.push(fmt(idLines[0].value));
      } else if (idLines.length > 1){
        lines.push(idLines.map(x=>x.text).join('\n'));
        lines.push('โขโขโขโขโขโขโขโขโขโขโขโขโขโขโขโขโขโขโขโขโขโขโข');
        lines.push('ุงููุฌููุน : ' + fmt(total));
        lines.push('โขโขโขโขโขโขโขโขโขโขโขโขโขโขโขโขโขโขโขโขโขโขโข');
      }
      return lines.filter(Boolean).join('\n');
    }

    function renderPersonCard(id){
      if (isPersonFeatureDisabled()) { personNote.textContent='โ'; personMsg.value=''; return; }
      personNote.textContent = 'ุฌุงุฑู ุฌูุจ ุงูุฑุณุงูุฉ...';
      personMsg.value = '';
      lastProfileIds = [];
      google.script.run
        .withSuccessHandler(card=>{
          if(!card || !card.ok){
            personNote.textContent = card?.message || 'ูู ูุชู ุงูุนุซูุฑ ุนูู ุจูุงูุงุช.';
            personMsg.value = '';
            return;
          }
          lastProfileIds = (card.ids||[]).map(x=> String(x.id));
          const txt = buildMessageText(card, applyDiscountToMessage.checked, localMap);
          personMsg.value = txt;
          personNote.textContent = `ุชู โ ุนุฏุฏ IDs: ${lastProfileIds.length}`;
          flash(personCardEl, 'flash-blue');

          clearDupUI();
          const dupList = [];
          lastProfileIds.forEach(uid=>{
            const node = localMap && localMap[uid];
            if (!node) return;
            if (node.aCol && node.dCol) dupList.push(`${uid} (ููุฑุฑ)`);
            else if (node.aCol)         dupList.push(`${uid} (ููุฑุฑ ููุงูุฉ ููุท)`);
            else if (node.dCol)         dupList.push(`${uid} (ููุฑุฑ ุงุฏุงุฑุฉ ููุท)`);
          });
          if (dupList.length){
            dupBadge.style.display='inline-block';
            dupBadge.textContent='ููุฑุฑ';
            extraDupInfo.textContent = 'IDs ููุฑุฑุฉ: ' + dupList.join('ุ ');
          }
        })
        .withFailureHandler(err=>{
          personNote.textContent = 'ุฎุทุฃ: ' + (err?.message||'');
          personMsg.value = '';
        })
        .getPersonCardById(id);
    }

    function rebuildPersonCardUsingLast(){
      if (isPersonFeatureDisabled()) return;
      if (lastBaseId){
        google.script.run
          .withSuccessHandler(card=>{
            if(card && card.ok){
              personMsg.value = buildMessageText(card, !!applyDiscountToMessage.checked, localMap);
              personNote.textContent = `ุชู โ ุนุฏุฏ IDs: ${(card.ids||[]).length}`;
            }
          })
          .getPersonCardById(lastBaseId);
      }
    }

    copyMsgBtn.addEventListener('click', async ()=>{
      try{
        await navigator.clipboard.writeText(personMsg.value||'');
        copyMsgBtn.textContent = 'โ ููุณุฎุช';
        setTimeout(()=> copyMsgBtn.textContent='ูุณุฎ ุงูุฑุณุงูุฉ', 900);
      }catch(_){
        personMsg.select(); document.execCommand('copy');
      }
    });

    colorAllBtn.addEventListener('click', ()=>{
      if (isPersonFeatureDisabled()) { personNote.textContent='ุงูููุฒุฉ ูุนุทููุฉ.'; return; }
      if (!lastProfileIds.length){ personNote.textContent='ูุง IDs ูุชูููููุง.'; return; }
      const sheet = sheetSelect.value;
      const targetMode = targetModeSel.value;
      if (targetMode==='both' && !sheet){ advNote.textContent='ุงุฎุชุฑ ูุฑูุฉ ุงููุฏู ุฃููุงู.'; return; }

      personNote.textContent = 'ุฌุงุฑู ุงูุชูููู...';
      let done=0, fail=0;
      const runOne = (uid)=> new Promise((resolve)=>{
        google.script.run
          .withSuccessHandler(_=>{ done++; resolve(true); })
          .withFailureHandler(_=>{ fail++; resolve(false); })
          .applyAdvancedAction(uid, sheet, adminColor.value, withdrawColor.value, targetMode);
      });
      Promise.all(lastProfileIds.map(runOne)).then(()=>{
        personNote.textContent = `ุชู โ ููููู: ${done}, ูุดู: ${fail}`;
        flash(personCardEl,'flash-green');
        if(localMap){
          lastProfileIds.forEach(uid=>{
            if(!localMap[uid]) return;
            localMap[uid].aCol = true;
            if (targetMode==='both') localMap[uid].dCol = true;
          });
        }
        refreshCountsLive();
      });
    });

    /******** ุชูููุฐ ุฐูู ********/
    function runAdvanced() {
      advNote.textContent = '... ุฌุงุฑู ุงูุชูููุฐ';
      const id = idInput.value.trim();
      if (!id) { advNote.textContent = 'โ๏ธ ุฃุฏุฎู ID ุฃููุงู'; return; }

      const sheet = sheetSelect.value;
      const targetMode = targetModeSel.value;
      if (targetMode === 'both' && !sheet) {
        advNote.textContent = 'โ๏ธ ุงุฎุชุฑ ูุฑูุฉ ุงููุฏู';
        return;
      }

      google.script.run
        .withSuccessHandler(res => {
          advNote.textContent = res?.message || 'ุชู โ';
          flash(advCard, 'flash-green');
          if (localMap && localMap[id]) {
            localMap[id].aCol = true;
            if (targetMode === 'both') localMap[id].dCol = true;
          }
          if (lastResult) renderResult(lastResult);
          refreshCountsLive();
        })
        .withFailureHandler(err => {
          advNote.textContent = 'ุฎุทุฃ: ' + (err?.message || '');
        })
        .applyAdvancedAction(id, sheet, adminColor.value, withdrawColor.value, targetMode);
    }
    advRunBtn.addEventListener('click', runAdvanced);

    /******** ุนุฏุงุฏ / ูุถุน ุฏุงูู / ุฅุฎูุงุก ุชุญููู ********/
    function fmtNum(n){ const x=Number(n); return isNaN(x)?'โ':new Intl.NumberFormat('en-US').format(x); }
    function refreshCountsLive(pctOverride){
      const pct = (typeof pctOverride === 'number') ? pctOverride : Number(discountInput?.value || 0);
      google.script.run
        .withSuccessHandler(res=>{
          if(!res || !res.ok){ qtColored.textContent='โ'; qtUncolored.textContent='โ'; return; }
          qtColored.textContent   = fmtNum(res.coloredRows || 0);
          qtUncolored.textContent = fmtNum(res.uncoloredRows || 0);
        })
        .withFailureHandler(()=>{ qtColored.textContent='โ'; qtUncolored.textContent='โ'; })
        .getLiveStatsForFooter(pct);
    }
    function applyModeLabel(){
      const isDark = document.body.classList.contains('dark');
      qtMode.textContent = isDark ? 'โ๏ธ ูุถุน ูุงุชุญ' : '๐ ูุถุน ุฏุงูู';
    }
    try { if (localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark'); } catch(_){}
    applyModeLabel();
    qtMode.addEventListener('click', ()=>{
      const isDark = document.body.classList.toggle('dark');
      applyModeLabel();
      try { localStorage.setItem('darkMode', isDark ? 'true':'false'); } catch(_){}
    });
    function applyHideState(){
      const loadCard = document.getElementById('loadCard');
      const hide = (localStorage.getItem('hide_loadsec') === '1');
      if (loadCard) loadCard.style.display = hide ? 'none' : '';
      qtHide.textContent = hide ? '๐ ุฅุธูุงุฑ ุงูุชุญููู' : '๐ ุฅุฎูุงุก ุงูุชุญููู';
    }
    applyHideState();
    qtHide.addEventListener('click', ()=>{
      const cur = localStorage.getItem('hide_loadsec') === '1';
      localStorage.setItem('hide_loadsec', cur ? '0':'1');
      applyHideState();
    });
    document.getElementById('qtRefreshCnt').addEventListener('click', refreshCountsLive);

    /******** ุงูุจุญุซ (ูุญูู ุฃููุงู ุซู ุงูุณูุฑูุฑ) ********/
    let querySeq = 0;
    function normalizeId(v){ return String(v||'').trim(); }

    function buildLocalResult(id){
      if (!localMap || (!localMap[id] && !Object.prototype.hasOwnProperty.call(localMap, id))) {
        // ูู ุบูุฑ ููุฌูุฏ ุจุงูููููุ ูููู ูููู "ุงุฏุงุฑุฉ ููุท" โ ูุชุฑู ููุณูุฑูุฑ ุงูุญูู
        return { status:'ุบูุฑ ููุฌูุฏ', totalSalary:'0.00', salaries:[], id:id, isDuplicate:false };
      }
      const node = localMap[id] || {};
      const inAdmin = !!node.inAdmin;
      const rowsCount = Number(node.rowsCount||0);
      const total = Number(node.sum||0);
      const salaries = Array.isArray(node.salaries) ? node.salaries.map(Number) : [];

      let status = 'ุบูุฑ ููุฌูุฏ';
      if (rowsCount > 0) {
        status = inAdmin ? ((rowsCount>1)? 'ุณุญุจ ููุงูุฉ - ุฑุงุชุจูู':'ุณุญุจ ููุงูุฉ') : ((rowsCount>1)? 'ุฑุงุชุจูู':'ููุงูุฉ');
      } else if (inAdmin) {
        status = 'ุงุฏุงุฑุฉ';
      }

      // ููุฑุฑุ
      let isDuplicate=false, duplicateLabel=null;
      const aCol = !!node.aCol;
      const dCol = !!node.dCol;
      if (aCol && dCol) { isDuplicate = true; duplicateLabel = 'ููุฑุฑ'; }
      else if (aCol)    { isDuplicate = true; duplicateLabel = 'ููุฑุฑ ููุงูุฉ ููุท'; }
      else if (dCol)    { isDuplicate = true; duplicateLabel = 'ููุฑุฑ ุงุฏุงุฑุฉ ููุท'; }

      return {
        status: status,
        totalSalary: total.toFixed(2),
        salaries: salaries,
        discountAmount: '0.00',
        salaryAfterDiscount: total.toFixed(2),
        id: id,
        isDuplicate: isDuplicate,
        duplicateLabel: duplicateLabel
      };
    }

    function doSearch(){
  const id = String(idInput.value||'').trim();
  if (!id){
    applyBadges('ุบูุฑ ููุฌูุฏ', null, false);
    amountText.textContent = 'โ';
    multiText.textContent  = '';
    personNote.textContent = 'โ';
    personMsg.value = '';
    clearDupUI();
    return;
  }

  saveLastId(id);
  lastBaseId = id;
  renderLoading(); // ุฃุจูู "ุฌุงุฑู ุงูุจุญุซโฆ" ูุงูุชุฑุงุถู

  const hasLocal = !!(localMap && Object.prototype.hasOwnProperty.call(localMap, id));
  if (hasLocal){
    // ุฅุฐุง ููุฌูุฏ ุจุงููููู: ุฃุนุฑุถ ูุญูููุง ููุฑูุง (ููุงูุฉ/ุณุญุจ ููุงูุฉ/ุฑุงุชุจูู)
    const node = localMap[id];
    const inAdmin   = !!node.inAdmin;
    const rowsCount = Number(node.rowsCount||0);
    const total     = Number(node.sum||0);
    const salaries  = Array.isArray(node.salaries) ? node.salaries.map(Number) : [];
    let status;
    if (rowsCount > 0) status = inAdmin ? ((rowsCount>1)? 'ุณุญุจ ููุงูุฉ - ุฑุงุชุจูู':'ุณุญุจ ููุงูุฉ')
                                        : ((rowsCount>1)? 'ุฑุงุชุจูู':'ููุงูุฉ');
    else status = 'ุบูุฑ ููุฌูุฏ';

    let isDuplicate=false, duplicateLabel=null;
    if (node.aCol && node.dCol) { isDuplicate = true; duplicateLabel = 'ููุฑุฑ'; }
    else if (node.aCol)         { isDuplicate = true; duplicateLabel = 'ููุฑุฑ ููุงูุฉ ููุท'; }
    else if (node.dCol)         { isDuplicate = true; duplicateLabel = 'ููุฑุฑ ุงุฏุงุฑุฉ ููุท'; }

    renderResult({
      status,
      totalSalary: total.toFixed(2),
      salaries,
      names: (Array.isArray(node.names) ? node.names : []),
      name: (Array.isArray(node.names) && node.names.length ? String(node.names[0]||'').trim() : ''),
      discountAmount: '0.00',
      salaryAfterDiscount: total.toFixed(2),
      id,
      isDuplicate,
      duplicateLabel
    });
  }
  // ุฅุฐุง ุบูุฑ ููุฌูุฏ ูุญูููุง (ูุฏ ูููู "ุฅุฏุงุฑุฉ ููุท"): ูุง ูุนุฑุถ "ุบูุฑ ููุฌูุฏ" โ ููุชุธุฑ ุฑุฏ ุงูุณูุฑูุฑ.

  const mySeq = (++window.__qseq || (window.__qseq=1));
  const pct = Number(discountInput?.value || 0);

  google.script.run
    .withSuccessHandler(res=>{
      if (mySeq !== window.__qseq) return; // ุชุฌุงูู ุงูุฑุฏูุฏ ุงููุชุฃุฎุฑุฉ
      if (!res || res.status === 'error'){
        if (res && res.message) renderResult({ status:'error', message: res.message });
        return;
      }
      renderResult(res);
      renderPersonCard(id);
    })
    .withFailureHandler(err=>{
      if (err && err.message) renderResult({ status:'error', message: err.message });
    })
    .searchId(id, pct);
}

    // ุชุญุฏูุซ ุงูุฎุตู ุฏูู ุงุชุตุงูุงุช
    (function(){
      if (!discountInput) return;
      let t;
      discountInput.addEventListener('input', ()=>{
        if (t) clearTimeout(t);
        t = setTimeout(()=>{
          if (lastResult) renderResult(lastResult);
          const pct = Math.max(0, Math.min(100, Number(discountInput.value)||0));
          refreshCountsLive(pct);
          if (applyDiscountToMessage?.checked && lastBaseId) rebuildPersonCardUsingLast();
        }, 120);
      });
    })();

    // ููููุฆ ุณููุชุด "ุชุตุญูุญ ุงูุฑุงุชุจ"
    function initSalaryCorrectionSwitch(){
      if (!enableSalaryCorrection) return;
      google.script.run
        .withSuccessHandler(res=>{
          try { enableSalaryCorrection.checked = !!(res && res.enabled); } catch(_){}
        })
        .withFailureHandler(()=>{})
        .getSalaryCorrectionEnabled();

      enableSalaryCorrection.addEventListener('change', ()=>{
        const desired = !!enableSalaryCorrection.checked;
        google.script.run
          .withSuccessHandler(res=>{
            if (!res || typeof res.enabled === 'undefined') return;
            if (!!res.enabled !== desired) enableSalaryCorrection.checked = !!res.enabled;
            if (lastBaseId) rebuildPersonCardUsingLast();
          })
          .withFailureHandler(()=>{ enableSalaryCorrection.checked = !desired; })
          .setSalaryCorrectionEnabled(desired ? 1 : 0);
      });
    }

    // ุฃูู ุชุญููู
    window.addEventListener('load', ()=>{
      applyPersonVisibility();
      loadLastId();
      loadData();
      fillSheets();
      initSalaryCorrectionSwitch();
      setTimeout(refreshCountsLive, 600);
    });
  </script>
  <style>
  @media (max-width: 1059px){
    #quickTools{
      grid-column: 1 / -1;
      grid-row: 999;
      margin-top: 12px;
    }
  }
  </style>
  <script>
  (function(){
    function placeQT(){
      var qt = document.getElementById('quickTools');
      var bulk = document.getElementById('bulkCard');
      var cont = document.querySelector('.container');
      if (!cont) return;
      var w = Math.min(window.innerWidth, document.documentElement.clientWidth || window.innerWidth);
      if (w <= 1059){
        if (qt) cont.appendChild(qt);
        if (bulk) cont.appendChild(bulk);
      }
    }
    window.addEventListener('load', placeQT);
    window.addEventListener('resize', function(){
      clearTimeout(window.__qt_fix);
      window.__qt_fix = setTimeout(placeQT, 150);
    });
  })();
  </script>
  <style>
  /* ุชุญุณูู ุชูุณูู ูุณู ุงูุชูููุฐ ุนูู ุงูุดุงุดุงุช ุงูุตุบูุฑุฉ */
  @media (max-width: 640px){
    /* ุฎูู ุตููู ุงููุณู ูุงุจูุฉ ูููู */
  #advCard .row{ flex-wrap: wrap !important; }

  /* ุตู (ุงููุฏู + ุงูุชูููุฐ + ุชุญุฏูุซ) */
  #advCard .row:first-of-type label.small{
    width: 100% !important;
    min-width: 0 !important;
    display: block;
    margin: 0 0 6px 0 !important;
    font-size: 12px;
    opacity: .9;
  }
  #advCard #sheetSelect,
  #advCard #targetMode{
    flex: 1 1 100% !important;
    width: 100% !important;
    min-width: 0 !important;
    height: 40px;
  }
  #advCard #refreshSheetsBtn{
    order: 3;                /* ูุฒููู ุชุญุช ุงูุญููู */
    width: 100%;
    margin-top: 6px;
  }

  /* ุตู ุงูุฃููุงู (ููู ุงูุฅุฏุงุฑุฉ / ุณุญุจ ููุงูุฉ) */
  #advCard .row[style*="flex-wrap:wrap"] > div{
    flex: 1 1 100% !important;
  }
  #advCard input[type="color"]{
    width: 40px !important;
    height: 34px !important;
  }

  /* ุตู ุฅูุดุงุก ูุฑูุฉ ุฌุฏูุฏุฉ */
  #advCard #newSheetName{
    flex: 1 1 100% !important;
    width: 100% !important;
  }
  #advCard #createSheetBtn{
    flex: 0 0 100% !important;
    width: 100% !important;
    margin-top: 6px;
  }

  /* ุตู ุงูุฎุตู + ุงูุณููุชุดุงุช */
  #advCard input[type="number"]{
    width: 100% !important;
    flex: 1 1 100% !important;
    height: 40px;
  }
  #advCard .toggle-chip{
    flex: 1 1 48% !important;
    justify-content: space-between;
    margin-top: 6px;
  }

  /* ุฒุฑ ุงูุชูููุฐ: ููู ูุงูู ุฃุตูุงูุ ูุฒูุฏ ุฑุงุญุฉ ุนูู ุงูููุจุงูู */
  #advCard #advRunBtn{
    padding: 14px 16px !important;
    font-size: 16px !important;
    border-radius: 12px !important;
  }

  /* ููุงุญุธุงุช ุงูุชูููุฐ ูุธูุฑ ูุงุถุญ ูุชุญุช ุงูุฒุฑ */
  #advCard #advNote{ font-size: 12px; line-height: 1.4; }
}
</style>

<script>
/* ุชุฑุชูุจ ุจุณูุท: ุถูู ุงูููุจุงููุ ุญุท ุฒุฑ ุงูุชุญุฏูุซ ุจุนุฏ ุงููุงุฆูุชูู ุฏุงุฆูุงู */
(function(){
  function fixAdvLayout(){
    var w = Math.min(window.innerWidth, document.documentElement.clientWidth||window.innerWidth);
    if (w > 640) return;
    var row = document.querySelector('#advCard .row');
    var btn = document.getElementById('refreshSheetsBtn');
    if(row && btn) row.appendChild(btn);
  }
  window.addEventListener('load', fixAdvLayout);
  window.addEventListener('resize', function(){ clearTimeout(window.__advFix); window.__advFix=setTimeout(fixAdvLayout,150); });
})();
</script>
<!-- ===== /Bulk IDs โ Advanced ===== -->
<!-- ุดุงุฑุฉ ุญุงูุฉ ุงูุฅูุชุฑูุช (ูุญุต ุฐููุ ูุง ูููุน ุงูุชูููุฐ ุนูุฏ ุงูุจุทุก) -->
<style>
  #netBadge{position:fixed;inset-inline-end:12px;inset-block-end:12px;z-index:9999;padding:6px 10px;border-radius:10px;font-size:12px;font-weight:700;box-shadow:0 4px 12px rgba(0,0,0,.15);background:#e5fbe5;border:1px solid #c6f6c6;color:#0b1020;display:flex;align-items:center;gap:6px}
  #netBadge.net-weak{background:#fff8e5;border-color:#ffe7a8;color:#6b4e00}
  #netBadge.net-down{background:#ffe5e5;border-color:#ffc2c2;color:#6b0000}
  #netBadge .dot{width:8px;height:8px;border-radius:50%;background:#16a34a}
  #netBadge.net-weak .dot{background:#f59e0b}
  #netBadge.net-down .dot{background:#ef4444}
</style>
<div id="netBadge"><span class="dot"></span><span id="netText">ูุญุต ุงูุงุชุตุงูโฆ</span></div>

<script>
(function(){
  const badge=document.getElementById('netBadge');
  const text=document.getElementById('netText');

  function setState(kind,label){
    badge.classList.remove('net-weak','net-down');
    if(kind==='ok'){ text.textContent=`ูุชุตู โ ${label||''}`.trim(); }
    else if(kind==='weak'){ badge.classList.add('net-weak'); text.textContent=`ุจุทูุก ๐ก ${label||''}`.trim(); }
    else { badge.classList.add('net-down'); text.textContent=`ุฃูููุงูู โ ${label||''}`.trim(); }
  }

  function pingServer(timeoutMs){
    return new Promise(res=>{
      let done=false, t0=performance.now();
      try{
        google.script.run
          .withSuccessHandler(()=>{ if(done) return; done=true; res({ok:true,rtt:performance.now()-t0}); })
          .withFailureHandler(()=>{ if(done) return; done=true; res({ok:false}); })
          .ping?.();
        setTimeout(()=>{ if(done) return; done=true; res({ok:false}); }, timeoutMs||2000);
      }catch(_){ res({ok:false}); }
    });
  }

  let lastPing=0;
  async function checkNow(){
    // ูุญุต ุงูุฌูุงุฒ ูู ุซุงููุฉ (ุณููุนููู ุจุงูinterval ุจุงูุฃุณูู)
    if(!navigator.onLine){ setState('down','(ุงูุฌูุงุฒ ุบูุฑ ูุชุตู)'); window.__serverReachable=false; return; }

    // ูุญุต ุงูุณูุฑูุฑ ูู 30 ุซุงููุฉ ููุท
    const now=Date.now();
    if(now-lastPing>30000){
      lastPing=now;
      const s=await pingServer(1500);
      if(s.ok){
        const rtt=Math.round(s.rtt||0);
        if(rtt<=700) setState('ok',`(${rtt}ms)`); else setState('weak',`(${rtt}ms)`);
        window.__serverReachable=true;   // ูุณุชููุฏ ูููุง ููุนุฑุถ ููุท
      }else{
        setState('weak','()'); // ุนุฑุถ ููุทุ ูุง ูููุน ุงูุชูููุฐ
        window.__serverReachable=false;
      }
    }
  }

  // ูุญุต ุงูุฌูุงุฒ ูู ุซุงููุฉ + ุงูุณูุฑูุฑ ูู 30 ุซุงููุฉ
  setInterval(checkNow,1000);
  checkNow();
  window.addEventListener('online',()=>{ lastPing=0; checkNow(); });
  window.addEventListener('offline',()=> setState('down','(ุงูุฌูุงุฒ ุบูุฑ ูุชุตู)'));

  // ๐ ุฃูู ุชุบููุฑ: ุงูุณูุงุญ ุจุงูุชูููุฐ ูุง ุฏุงู ุงูุฌูุงุฒ Online ุญุชู ูู ุงูุณูุฑูุฑ ุจุทูุก
  window.netEnsureOnline = async function(){
    // ูู ุงูุฌูุงุฒ ุฃูููุงูู ููุท ูููุน
    if(!navigator.onLine){
      alert('โ ุงูุฌูุงุฒ ุบูุฑ ูุชุตู ุจุงูุฅูุชุฑูุช');
      return false;
    }
    // ุฎูุงู ุฐูู ูุณูุญ ุฏูููุง (ุณุฑูุน ุฃู ุจุทูุก / ุงูุณูุฑูุฑ ูุชุฃุฎุฑ ุจุงูุฑุฏ)
    return true;
  };
})();
</script>
<script>
/* ุญุงุฑุณ ุฒุฑ ุงูุชูููุฐ โ ูููุน ุงูุชูููุฐ ูู ุงูุงุชุตุงู ุบูุฑ ุฌุงูุฒ (ุจุฏูู ููุณ ููุฏู ุงูุฃุตูู) */
(function guardExecButton(){
  const SELECTORS = ['#advRunBtn']; // ุฃุถู ุฃุฒุฑุงุฑ ุฃุฎุฑู ููุง ูู ุชุญุจ

  function isServerLikelyUp(){
    if (window.__serverReachable === true)  return true;
    if (window.__serverReachable === false) return false;
    return navigator.onLine; // ุชูุฏูุฑ ุณุฑูุน
  }

  async function ensureOnlineInteractive(){
    if (typeof window.netEnsureOnline === 'function'){
      return await window.netEnsureOnline();
    }
    if (!navigator.onLine){ alert('โ ุงูุฌูุงุฒ ุฃูููุงูู โ ูู ูุชู ุงูุชูููุฐ.'); return false; }
    if (window.__serverReachable === false){ alert('๐ก ุงูุณูุฑูุฑ ุบูุฑ ูุชุงุญ โ ุฃุนุฏ ุงููุญุงููุฉ ุฃู ุญุฏูุซ ุงูุตูุญุฉ.'); return false; }
    return true;
    }

  function handlerCapture(e){
    const btn = e.target.closest(SELECTORS.join(','));
    if (!btn) return;
    e.preventDefault();
    e.stopImmediatePropagation();

    (async ()=>{
      if (!isServerLikelyUp()){
        const ok = await ensureOnlineInteractive();
        if (!ok) return;
      } else {
        const ok = await ensureOnlineInteractive();
        if (!ok) return;
      }
      // ูุฑูุช ุงูุดุฑูุท โ โ ุฃุนุฏ ุฅุทูุงู ุงูููุฑ ููููู ููุฏู ุงูุฃุตูู
      document.removeEventListener('click', handlerCapture, true);
      try { btn.click(); } finally {
        setTimeout(()=> document.addEventListener('click', handlerCapture, true), 0);
      }
    })();
  }

  document.addEventListener('click', handlerCapture, true);
})();
</script>
<!-- ======= ุณุฌู ุงูููู โ ูุงุฌูุฉ ููุงุฆูุฉ ======= -->
<style>
  .lgp-btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;
    padding:12px 14px;border:1px solid #16a34a;background:#22c55e;color:#fff;
    font-weight:800;cursor:pointer;width:100%;margin:10px 0;border-radius:12px}
  .lgp-btn:disabled{opacity:.6;cursor:not-allowed}

  .lgp-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;
    background:rgba(0,0,0,.35);z-index:99999}
  .lgp-modal.show{display:flex}
  .lgp-sheet{width:min(92vw,560px);padding:14px;background:var(--card-bg,#111827);color:var(--fg,#e5e7eb);
    box-shadow:0 12px 28px rgba(0,0,0,.25);border:1px solid var(--border,#374151);border-radius:12px;overflow:hidden}
  .lgp-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .lgp-title h3{margin:0;font-size:16px;font-weight:800}
  .lgp-ghost{border:1px solid var(--border,#374151);background:transparent;padding:8px 12px;color:inherit;border-radius:12px}

  .lgp-list{max-height:56vh;overflow:auto;border:1px solid var(--border,#374151);background:rgba(255,255,255,.02);border-radius:12px}
  .lgp-row{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:10px;border-bottom:1px solid var(--border,#374151)}
  .lgp-row:last-child{border-bottom:0}
  .lgp-id{font-family:ui-monospace,monospace;font-weight:800}
  .lgp-meta{font-size:11px;opacity:.8}

  .lgp-controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .lgp-select,.lgp-color{border:1px solid var(--border,#374151);background:transparent;color:inherit;padding:10px;border-radius:12px}
  .lgp-primary{background:#22c55e;border:1px solid #16a34a;color:#fff;padding:12px;font-weight:800;border-radius:12px}

  .lgp-toggle{display:inline-flex;align-items:center;gap:10px}
  .ios-switch{position:relative;width:48px;height:28px}
  .ios-switch input{appearance:none;-webkit-appearance:none;width:48px;height:28px;margin:0;cursor:pointer}
  .ios-switch .track{position:absolute;inset:0;background:#6b7280;transition:.2s;border-radius:999px}
  .ios-switch .thumb{position:absolute;top:3px;left:3px;width:22px;height:22px;background:#fff;border-radius:50%;box-shadow:0 1px 3px rgba(0,0,0,.25);transition:.2s}
  .ios-switch input:checked ~ .track{ background:#22c55e }
  .ios-switch input:checked ~ .thumb{ left:23px }

  .lgp-color{ width:44px;height:34px;padding:0 }
  .lgp-hint{font-size:12px;opacity:.75;margin-top:6px}
</style>

<!-- ุฒุฑ "ุงูุณุฌู" (ููุฒุฑูุน ุชููุงุฆููุง ุชุญุช ุฒุฑ ุงูุชูููุฐ) -->
<div id="lgpMount" style="display:none">
  <button id="lgpOpen" class="lgp-btn">๐ ุงูุณุฌู</button>
</div>

<!-- ุงููุงูุฐุฉ ุงูููุจุซูุฉ -->
<div id="lgpModal" class="lgp-modal" role="dialog" aria-modal="true">
  <div class="lgp-sheet">
    <div class="lgp-title">
      <h3>๐ ุณุฌู ุงูููู (ุขุฎุฑ 15)</h3>
      <button id="lgpClose" class="lgp-ghost">ุฅุบูุงู</button>
    </div>

    <div id="lgpList" class="lgp-list">
      <div class="lgp-row"><div></div><div>โฆ ุฌุงุฑู ุงูุชุญููู</div><div></div></div>
    </div>

    <div class="lgp-controls">
      <select id="lgpTarget" class="lgp-select" title="ุงุฎุชุฑ ูุฑูุฉ ุงููุฏู">
        <option>โฆ ุฌุงุฑู ุงูุชุญููู</option>
      </select>

      <div class="lgp-toggle">
        <span style="font-size:12px;opacity:.8">ููู ูุฎุตูุต</span>
        <label class="ios-switch">
          <input id="lgpUseCustom" type="checkbox">
          <span class="track"></span><span class="thumb"></span>
        </label>
      </div>
      <input id="lgpColor" type="color" class="lgp-color" value="#ddd6fe" title="ููู ุจุนุฏ ุงูููู" disabled>

      <button id="lgpMove" class="lgp-primary">ููู ุงููุญุฏุฏ</button>
    </div>

    <div id="lgpHint" class="lgp-hint"></div>
  </div>
</div>

<script>
/* ุฒุฑุน ุฒุฑ ุงูุณุฌู ุชุญุช ุฒุฑ ุชูููุฐ (ุญุณุจ ุงููุชูุฌุฉ) */
(function(){
  var mount = document.getElementById('lgpMount');
  function placeButton(){
    var host=null, runBtn=document.getElementById('advRunBtn');
    if(runBtn) host=runBtn.closest('.card');
    if(!host) host=document.getElementById('advCard');
    if(!host){ var cards=document.querySelectorAll('.card'); if(cards.length) host=cards[cards.length-1]; }
    if(!host) host=document.body;
    if(mount.parentNode!==host) host.appendChild(mount);
    mount.style.display='block';
  }
  function ensureMounted(){
    placeButton();
    setTimeout(placeButton,150); setTimeout(placeButton,400); setTimeout(placeButton,1000);
    window.addEventListener('resize',()=>setTimeout(placeButton,150));
    new MutationObserver(()=>placeButton()).observe(document.body,{childList:true,subtree:true});
  }
  (document.readyState==='loading') ? document.addEventListener('DOMContentLoaded',ensureMounted) : ensureMounted();
})();

/* ูุงุฌูุฉ ุงูุณุฌู */
(function(){
  var modal=document.getElementById('lgpModal');
  var openBtn=document.getElementById('lgpOpen');
  var closeBtn=document.getElementById('lgpClose');
  var list=document.getElementById('lgpList');
  var sel=document.getElementById('lgpTarget');
  var useCustom=document.getElementById('lgpUseCustom');
  var colorInp=document.getElementById('lgpColor');
  var move=document.getElementById('lgpMove');
  var hint=document.getElementById('lgpHint');

  function setHint(msg){ if(hint) hint.textContent = msg || ''; }

  function renderList(items){
    list.innerHTML='';
    if(!items||!items.length){
      list.innerHTML='<div class="lgp-row"><div></div><div>ูุง ููุฌุฏ ุณุฌู</div><div></div></div>';
      list.__rows__=[];
      return;
    }
    items.forEach(function(it,i){
      var row=document.createElement('div');
      row.className='lgp-row';
      row.innerHTML = `
        <label><input type="checkbox" data-idx="${i}"></label>
        <div>
          <div class="lgp-id">${it.id||'โ'} | ${it.target||'โ'}</div>
          <div class="lgp-meta">${it.at||''} โข ุตููู: ${it.rows||1}</div>
        </div>
        <div style="width:18px;height:18px;border:1px solid var(--border,#374151);border-radius:6px;background:${it.color||'transparent'}"></div>
      `;
      list.appendChild(row);
    });
    list.__rows__ = items || [];
  }

  function loadAll(){
    list.innerHTML='<div class="lgp-row"><div></div><div>โฆ ุฌุงุฑู ุงูุชุญููู</div><div></div></div>';
    sel.innerHTML='<option>โฆ ุฌุงุฑู ุงูุชุญููู</option>';
    setHint('ุชุญููู ุงูุณุฌู ูุงูุฃูุฑุงูโฆ');

    // ุงูุณุฌู
    google.script.run
      .withSuccessHandler(function(items){ renderList(items||[]); setHint(''); })
      .withFailureHandler(function(err){
        list.innerHTML='<div class="lgp-row"><div></div><div>โ๏ธ ุฎุทุฃ getMoveLogLatest: '+(err&&err.message||'')+'</div><div></div></div>';
        list.__rows__=[];
        setHint('');
      })
      .getMoveLogLatest(15);

    // ุฃุณูุงุก ุงูุฃูุฑุงู (ูุณุชุฎุฏู getAdminSheetsSafeุ ูุฅู ูุดู ูุญุงูู getAdminSheets)
    google.script.run
      .withSuccessHandler(function(arr){
        sel.innerHTML='';
        (arr||[]).forEach(function(n){
          var o=document.createElement('option'); o.value=o.textContent=n; sel.appendChild(o);
        });
        var sheetSelect=document.getElementById('sheetSelect');
        if(sheetSelect && sheetSelect.value) sel.value = sheetSelect.value;
      })
      .withFailureHandler(function(){
        google.script.run
          .withSuccessHandler(function(arr){
            sel.innerHTML='';
            (arr||[]).forEach(function(n){
              var o=document.createElement('option'); o.value=o.textContent=n; sel.appendChild(o);
            });
          })
          .withFailureHandler(function(err){
            sel.innerHTML=''; var o=document.createElement('option');
            o.textContent='โ๏ธ ูุดู ุงูุญุตูู ุนูู ุฃุณูุงุก ุงูุฃูุฑุงู: '+(err&&err.message||''); sel.appendChild(o);
          })
          .getAdminSheets();
      })
      .getAdminSheetsSafe();
  }

  // ูุชุญ/ุฅุบูุงู
  openBtn && openBtn.addEventListener('click', ()=>{ loadAll(); modal.classList.add('show'); });
  closeBtn && closeBtn.addEventListener('click', ()=> modal.classList.remove('show'));
  modal.addEventListener('click', e=>{ if(e.target===modal) modal.classList.remove('show'); });

  // ุชูุนูู/ุชุนุทูู ููู ูุฎุตุต
  function syncColor(){ colorInp.disabled = !useCustom.checked; colorInp.style.opacity = useCustom.checked ? '1' : '.55'; }
  useCustom && useCustom.addEventListener('change', syncColor); syncColor();

  // ููู ุงููุญุฏุฏ
  move && move.addEventListener('click', function(){
    var checks = Array.from(list.querySelectorAll('input[type=checkbox]:checked'));
    if(!checks.length){ alert('ุงุฎุชุฑ ุนูุงุตุฑ ููููู'); return; }
    var rows = list.__rows__ || [];
    var pick = checks.map(function(ch){ var r=rows[+ch.dataset.idx]||{}; return { id:(r.id||''), from:(r.target||'') }; });
    var override = useCustom && useCustom.checked ? (colorInp.value||'') : '';

    move.disabled=true; move.textContent='ุฌุงุฑู ุงููููโฆ';
    google.script.run
      .withSuccessHandler(function(res){
        move.disabled=false; move.textContent='ููู ุงููุญุฏุฏ';
        alert(res && res.message ? res.message : 'ุชู.');
        loadAll();
      })
      .withFailureHandler(function(err){
        move.disabled=false; move.textContent='ููู ุงููุญุฏุฏ';
        alert('ุฎุทุฃ: '+(err&&err.message||'')); 
      })
      .moveFromLog(pick, sel.value||'', override);
  });
})();
</script>
<?!= HtmlService.createHtmlOutputFromFile('AIClient').getContent(); ?>
</script>
<!-- โ ุชุฑุชูุจ ููุญูุฏ + ุชุซุจูุช ุงูุฃุฏูุงุช ุงูุณุฑูุนุฉ + ุชูุณูู ุตู ุงูุจุญุซ -->
<style id="unified_mobile_layout">
  @media (max-width:1200px){
    .container{
      display:grid !important;
      grid-template-columns:1fr !important;
      grid-template-areas:
        "load"
        "results"
        "search"
        "exec"
        "person"
        "quick"
        "bulk";
      gap:14px !important;
    }

    /* ุงุฑุจุท ุงูููุงุทู */
    #loadCard   { grid-area: load    !important; }
    #resultsBox { grid-area: results !important; }
    #searchCard { grid-area: search  !important; }
    #execCard   { grid-area: exec    !important; }
    #personCard { grid-area: person  !important; }
    #quickTools { grid-area: quick   !important; }
    #bulkCard   { grid-area: bulk    !important; }

    /* ุฎููู ุงููุฑูุช ุนูู ุงูููุจุงูู */
    .card{
      background:transparent !important;
      border:0 !important;
      box-shadow:none !important;
      border-radius:12px !important;
      padding:12px !important;
      margin:0 !important;
    }

    /* ุงูุจุญุซ: ุญูู + ุฒุฑ ุงููุตู ุฌูุจ ุจุนุถ */
    #searchCard .row,
    #searchCard .row.stretch{
      display:grid !important;
      grid-template-columns:1fr auto !important;
      column-gap:8px !important;
      align-items:stretch !important;
      width:100% !important;
    }
    #idInput{
      width:100% !important; 
      min-height:44px !important; 
      font-size:16px !important;
    }
    #pasteSearchBtn{
      height:44px !important; 
      min-width:130px !important; 
      white-space:nowrap !important; 
      font-weight:700 !important;
    }
  }
</style>

<script>
/* โ JS ุฏุงุนู: ูุถูู ูุถุน #quickTools ุจุนุฏ #personCard (ุฅู ูุงู ุธุงูุฑ) ูุฅูุง ุจุนุฏ #execCard + ูุซุจุช ุฒุฑ ุงููุตู ุจุฌุงูุจ ุงูุญูู */
(function(){
  var IDS = { results:'resultsBox', search:'searchCard', exec:'execCard', person:'personCard', quick:'quickTools', bulk:'bulkCard' };

  function $(id){ return document.getElementById(id); }
  function visible(el){
    if (!el) return false;
    var cs = getComputedStyle(el);
    return el.offsetParent !== null && cs.display!=='none' && cs.visibility!=='hidden' && cs.opacity!=='0';
  }

  function placeQuickTools(){
    var qt = $(IDS.quick), exec = $(IDS.exec), person = $(IDS.person), bulk = $(IDS.bulk);
    if (!qt || !exec) return;

    var anchor = (person && visible(person)) ? person : exec;
    var parent = anchor.parentNode;

    // ุงููู quickTools ูููุณ ุงูุฃุจ ุซู ุถุนู ุจุนุฏ ุงูู anchor
    if (qt.parentNode !== parent) parent.appendChild(qt);
    if (qt.previousElementSibling !== anchor) parent.insertBefore(qt, anchor.nextSibling);

    if (bulk) {
      if (bulk.parentNode !== parent) parent.appendChild(bulk);
      if (bulk.previousElementSibling !== qt) parent.insertBefore(bulk, qt.nextSibling);
      bulk.style.maxWidth = '100%';
      bulk.style.margin = '0 auto';
    }

    // ุถุจุท ููุงุณุงุช ูุทููุฉ
    qt.style.maxWidth = '780px';
    qt.style.width    = '100%';
    qt.style.margin   = '12px auto';
  }

  function fixSearchRow(){
    var sc = $(IDS.search);
    if (!sc) return;
    // ุชุฃูุฏ ุฃู ุฒุฑ ุงููุตู ุฃุฎ ููุญูู ุฏุงุฎู ููุณ ุตู .row
    var input = sc.querySelector('#idInput');
    var btn   = document.getElementById('pasteSearchBtn');
    var row   = sc.querySelector('.row') || sc.querySelector('.row.stretch') || sc;
    if (input && btn && row && btn.parentNode !== row){
      row.appendChild(btn);
    }
    // ูุฑุถ ุงูุดุจูุฉ (ุงุญุชูุงุท ูู ูุณุฑุช ููุงุนุฏ ุณุงุจูุฉ)
    row.style.display = 'grid';
    row.style.gridTemplateColumns = '1fr auto';
    row.style.columnGap = '8px';
    row.style.alignItems = 'stretch';
  }

  function run(){
    placeQuickTools();
    fixSearchRow();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', run);
  } else {
    run();
  }

  // ุฑุงูุจ ุฃู ุชุบููุฑ ูุฃุนุฏ ุงูุชุฑุชูุจ ุชููุงุฆููุง
  var obs = new MutationObserver(run);
  obs.observe(document.body, { childList:true, subtree:true, attributes:true, attributeFilter:['style','class'] });
  window.addEventListener('resize', run);
})();
</script>
<script>
(function(){
  if (typeof renderResult !== 'function') return;
  const _orig = renderResult;

  renderResult = function(res){
    // ุงุฑุณู ุงููุชูุฌุฉ ุงูุฃุตููุฉ ุฃููุงู (ุงูุฑุงุชุจ/ุงูุญุงูุฉโฆ)
    _orig(res);

    // ุซู ุนุฒูุฒ "ููุฑุฑ" ูุญูููุง ููุฑูุง
    try{
      const dupBadge = document.getElementById('dupBadge'); // ุดุงุฑุฉ "ููุฑุฑ" ุงูุญุงููุฉ
      const id = (res && res.id) ? String(res.id).trim() : '';

      // ูู ุงูุณูุฑูุฑ ูุณู ูุง ุฑุฌูุน "ููุฑุฑ"ุ ุจุณ ูุญูุง ุดุงูููู ุชูููุฐ ููุฑู ููุงููID
      const serverSaysDup = !!(res && (res.isDuplicate || res.dupFlavor));
      if (id && justColored[id] && !serverSaysDup) {
        if (dupBadge){
          dupBadge.style.display = '';
          dupBadge.textContent = (justColored[id] === 'both') ? 'ููุฑุฑ' : 'ููุฑุฑ ููุงูุฉ ููุท';
        }
        // (ุงุฎุชูุงุฑู) ุงูุณุญ ุงูุนูุงูุฉ ุจุนุฏ ุฃูู ุฅุธูุงุฑ ูุญุชู ูุง ุชุถู ูุนู
        // delete justColored[id];
      } else if (dupBadge && !serverSaysDup) {
        // ูุง ูู ูุง ูุญูู ููุง ุณูุฑูุฑ โ ุฃุฎูู ุงูุดุงุฑุฉ
        dupBadge.style.display = 'none';
      }
    }catch(_){}
  };

  // ูุธุงูุฉ ุจุตุฑูุฉ: ููุง ุชุบููุฑ ุงููID ุฃู ูุจุฏุฃ ุจุญุซ ุฌุฏูุฏ ุงูุณุญ ุงูุดุงุฑุฉ ุจุณุฑุนุฉ
  try {
    const idInput = document.getElementById('idInput');
    if (idInput){
      idInput.addEventListener('input', ()=>{
        const dupBadge = document.getElementById('dupBadge');
        if (dupBadge) dupBadge.style.display = 'none';
      });
    }
    if (typeof renderLoading === 'function'){
      const _rl = renderLoading;
      renderLoading = function(){
        _rl();
        const dupBadge = document.getElementById('dupBadge');
        if (dupBadge) dupBadge.style.display = 'none';
      };
    }
  } catch (_){}
})();
</script>
</body>
</html>